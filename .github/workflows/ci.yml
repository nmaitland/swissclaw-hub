name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, windwurf_dev ]
  pull_request:
    branches: [ main, master, windwurf_dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: swissclaw_hub_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5433:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint
      continue-on-error: true

    - name: Run type checking
      run: npm run type-check
      continue-on-error: true

    - name: Wait for PostgreSQL
      run: |
        for i in {1..10}; do
          pg_isready -h localhost -p 5433 -U postgres && break
          sleep 2
        done

    - name: Run database migrations
      run: npm run db:migrate:test
      env:
        NODE_ENV: test
        TEST_DB_HOST: localhost
        TEST_DB_PORT: 5433
        TEST_DB_NAME: swissclaw_hub_test
        TEST_DB_USER: postgres
        TEST_DB_PASSWORD: password

    - name: Run database seeders
      run: npm run db:seed:test
      env:
        NODE_ENV: test
        TEST_DB_HOST: localhost
        TEST_DB_PORT: 5433
        TEST_DB_NAME: swissclaw_hub_test
        TEST_DB_USER: postgres
        TEST_DB_PASSWORD: password

    - name: Run all backend tests with coverage
      run: npm test -- --coverage --coverageReporters=text-summary --coverageReporters=lcov --coverageReporters=text --runInBand --forceExit
      env:
        NODE_ENV: test
        CI: true
        TEST_DB_HOST: localhost
        TEST_DB_PORT: 5433
        TEST_DB_NAME: swissclaw_hub_test
        TEST_DB_USER: postgres
        TEST_DB_PASSWORD: password
      timeout-minutes: 10

    - name: Upload backend coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false

    - name: Install client dependencies
      run: cd client && npm ci

    - name: Run client tests with coverage
      run: cd client && npx jest --coverage --coverageReporters=text-summary --coverageReporters=lcov --coverageReporters=text --forceExit
      env:
        CI: true

    - name: Upload client coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./client/coverage/lcov.info
        flags: frontend
        name: client-coverage
        fail_ci_if_error: false

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          function parseLcov(file) {
            if (!fs.existsSync(file)) return null;
            const lines = fs.readFileSync(file, 'utf8').split('\n');
            let total = 0, covered = 0;
            lines.forEach(line => {
              if (line.startsWith('LF:')) total += parseInt(line.split(':')[1]) || 0;
              if (line.startsWith('LH:')) covered += parseInt(line.split(':')[1]) || 0;
            });
            const pct = total > 0 ? Math.round((covered / total) * 100) : 0;
            return { total, covered, pct };
          }
          const backend = parseLcov('./coverage/lcov.info');
          const client = parseLcov('./client/coverage/lcov.info');
          let body = '## Test Coverage Report\n\n';
          if (backend) body += `**Backend: ${backend.pct}%** (${backend.covered}/${backend.total} lines)\n`;
          if (client) body += `**Frontend: ${client.pct}%** (${client.covered}/${client.total} lines)\n`;
          if (!backend && !client) return;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          }).catch(() => {});

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build server
      run: npm run server:build

    - name: Build client
      run: |
        cd client
        npm ci
        npm run build
